@{
    ViewData["Title"] = "Users Management";
}

<h2>Users Managements</h2>

<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addUserModal">
    <i class="bi bi-plus-circle"></i> Add User
</button>


<table id="usersTable" class="display" style="width:100%">
    <thead>
        <tr>
            <th>First Name</th>
            <th>Last Name</th>
            <th>User Name</th>
            <th>NIC</th>
            <th>Email</th>
            <th>Phone No</th>
            <th>Address</th>
            <th>User Type</th>
            <th>Created On</th>
            <th>Action</th>
        </tr>
    </thead>
</table>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="addUserForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label>First Name</label>
                            <input type="text" class="form-control" name="FirstName" id="FirstName" required>
                        </div>
                        <div class="col-md-6">
                            <label>Last Name</label>
                            <input type="text" class="form-control" name="LastName" required>
                        </div>
                        <div class="col-md-6">
                            <label>User Name</label>
                            <input type="text" class="form-control" name="UserName" id="UserName" readonly required>
                        </div>
                        <div class="col-md-6">
                            <label>Password</label>
                            <input type="text" class="form-control" name="Password" id="Password" required
                                   minlength="10" maxlength="10"
                                   pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[^A-Za-z\d]).{10}$"
                                   title="Password must be exactly 10 characters and include at least one letter, one number, and one special character.">
                        </div>

                        <div class="col-md-6">
                            <label>NIC</label>
                            <input type="text" class="form-control" name="NIC">
                        </div>
                        <div class="col-md-6">
                            <label>Email</label>
                            <input type="email" class="form-control" name="Email" id="Email" required>
                        </div>
                        <div class="col-md-6">
                            <label>Phone No</label>
                            <input type="text" class="form-control" name="PhoneNo">
                        </div>
                        <div class="col-md-6">
                            <label>Address</label>
                            <input type="text" class="form-control" name="Address">
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        $(document).ready(function () {
            $('#usersTable').DataTable({
                "ajax": {
                    "url":  '@Url.Action("GetUsers", "Permissions")',//       "/Permissions/GetUsers",
                    "type": "GET",
                    "datatype": "json"
                },
                "pageLength": 50,       // show 50 rows by default
                "lengthChange": false,  // hide the "Show X entries" dropdown
                 "info": false,
                "columns": [
                    { "data": "firstName" },
                    { "data": "lastName" },
                    { "data": "userName" },
                    { "data": "nic" },
                    { "data": "email" },
                    { "data": "phoneNo" },
                    { "data": "address" },
                    { "data": "userType" },
                    {
                        "data": "createdOn",
                        "render": function (data) {
                            return new Date(data).toLocaleDateString();
                        }
                    },
                    {
                    "data": "id",
                    "render": function (data, type, row) {
                        if (!data) return "";

                        if (row.userType.toLowerCase() === "admin") {
                            return `<span class="text-muted">Delete Disabled</span>`;
                        }
                     return `<a href="#" class="text-danger delete-user" data-id="${row.id}" data-userName="${row.userName}" >Delete</a>`;},
                    "orderable": false
                    }

                ]
            });

            // Handle Add User Form Submission
        $('#addUserForm').on('submit', function (e) {
                e.preventDefault();
                var formData = $(this).serialize();
                $.ajax({
                    url: '@Url.Action("AddUser", "Permissions")',// '/Permissions/AddUser',
                    type: 'POST',
                    data: formData,
                    success: function (response) {
                         $('#usersTable').DataTable().ajax.reload(null, false);
                        $('#addUserModal').modal('hide');
                        $('#addUserForm')[0].reset();
                        table.ajax.reload(null, false); // Reload DataTable without full refresh
                        alert("User added successfully.");
                    },
                    error: function () {
                        alert("Error while saving user.");
                    }
                });
            });

        function generateRandomString(length) {
            var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789#$&';
            var result = '';
            for (var i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        $('#FirstName').on('input', function () {
            var firstName = $(this).val().trim();
            if (firstName.length > 0) {
                var randomPart = generateRandomString(10);
                var userName = (firstName + randomPart);
                $('#UserName').val(userName);
            } else {
                $('#UserName').val('');
            }
        });


        $('#usersTable').on('click', '.delete-user', function (e) {
        e.preventDefault();
           var userId = $(this).data('id');
           var userName=$(this).data('username');
            if (confirm(`Are you sure you want to delete user '${userName}'?`)) {
                $.ajax({
                    url:'@Url.Action("DeleteUser", "Permissions")',// '/Permissions/DeleteUser',
                    type: 'POST',
                    data: { id: userId },
                    success: function (response) {
                        $('#usersTable').DataTable().ajax.reload(null, false);
                    },
                    error: function () {
                        alert("Error deleting user.");
                    }
                });
            }
        });

        });
    </script>
}